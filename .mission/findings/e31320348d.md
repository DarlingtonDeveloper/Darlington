# Summary

Code review of MC Dashboard Mission 3B — all changed files reviewed against requirements in 86c49fc6a2.md.

## Verdict: Generally solid implementation with several issues to address

---

## Critical Issues

### C1: `handleStageOverride` ignores `reason` field (handlers.go:478)

The `StageOverrideRequest` is decoded with a `reason` field, and the frontend **requires** reason (dialog enforces non-empty). But the handler only passes `"stage", "set", req.Stage` — the reason is silently dropped. Per R4.3, should pass `--reason` flag.

```go
// Current:
out, err := s.runMC("stage", "set", req.Stage)
// Should be:
args := []string{"stage", "set", req.Stage}
if req.Reason != "" {
    args = append(args, "--reason", req.Reason)
}
out, err := s.runMC(args...)
```

### C2: `handleStageOverride` doesn't broadcast via WebSocket (handlers.go:478)

Gate approve/reject both call `s.hub.BroadcastRaw(...)` but stage override doesn't. The frontend relies on WS "stage" events to update — without a broadcast, other connected clients won't see the change until refresh.

### C3: `handleProjectSwitch` has no mutex — race on `s.missionDir` (handlers.go:494)

`s.missionDir` is read by every handler and written by `handleProjectSwitch` with no synchronization. Concurrent requests during a project switch could read inconsistent state. Needs `sync.RWMutex`.

---

## Moderate Issues

### M1: Duplicate checkpoint loading logic (handlers.go vs serve.go)

`loadCheckpoints()` in handlers.go and the checkpoint block in `buildState()` in serve.go are identical ~30-line copy-paste. The serve.go `buildState` should call `loadCheckpoints` via the api.Server (or extract to a shared function) to avoid drift.

### M2: `buildState` reads gates differently than `handleStatus` (serve.go:173)

`buildState` unwraps `{"gates": {...}}` wrapper, but `handleStatus` in handlers.go reads gates.json directly without unwrapping. One of them is wrong — they'll return different shapes for the same file. This could cause WS initial sync to show different gate data than the REST endpoint.

### M3: `handleProjectSwitch` doesn't broadcast project change (handlers.go:505)

Per R3.3, switching projects should notify WS subscribers to re-sync. Currently the frontend works around this with `window.location.reload()` in mc-client.tsx, but other clients won't know. Should broadcast on hub.

### M4: Cost calculation is hardcoded and inaccurate (dashboard-header.tsx:19)

```ts
function formatCost(tokens: number): string {
  return `$${(tokens * 0.000003).toFixed(4)}`;
}
```

Hardcoded $3/1M rate. The `TokenSummary` type already has `total_cost` — should use that instead.

### M5: Hardcoded burn rate (dashboard-header.tsx:98)

```ts
const burnRate = 142; // TODO: derive from token history
```

This TODO should be addressed or the metric hidden. Displaying a static fake number is misleading.

---

## Minor Issues

### m1: `taskStatusCounts` assumes fixed keys (mission-view.tsx:33)

```ts
const counts = { pending: 0, in_progress: 0, complete: 0, blocked: 0 };
zoneTasks.forEach((t) => {
  counts[t.status] = (counts[t.status] || 0) + 1;
});
```

TypeScript won't error if a new status is added to `TaskStatus` but not to this object. Could use `Record<TaskStatus, number>` for safety.

### m2: `ZONE_GLYPHS` defined but not used in mission-view.tsx (types.ts:26)

R2.3 requires zone glyphs in zone headers. `mission-view.tsx` renders zones via `<ZoneGroup>` but doesn't pass or use glyphs. The `ZONE_GLYPHS` map exists in types.ts but is unused in the reviewed files.

### m3: Stage override dialog requires reason but backend doesn't (mismatch)

The dialog enforces `if (!reason.trim()) { setError("Reason is required") }` but the backend `handleStageOverride` has no reason validation. Requirements say "Reason field is optional but passed through if provided." The frontend is stricter than required — harmless but inconsistent with spec.

### m4: `readJSONL` duplicated between handlers.go and serve.go

Two different `readJSONL` implementations exist — handlers.go returns `[]map[string]interface{}`, serve.go returns `[]interface{}`. Should consolidate.

### m5: No error handling on fetch calls in mc-client.tsx

`handleKillWorker`, `handleApproveGate`, `handleRejectGate`, `handleCreateCheckpoint`, `handleRestoreCheckpoint` all fire-and-forget with no error feedback to the user. Only `handleStageOverride` checks the response.

### m6: Checkpoint `created_at` set to filename (handlers.go:295)

```go
"created_at": name, // e.g. "2026-02-10T23-28-00Z"
```

If the filename isn't a valid ISO timestamp, `new Date(cp.created_at)` in the frontend will produce "Invalid Date". No validation on the format.

---

## Patterns & Quality

**Good:**

- Clean separation of API server vs serve entrypoint
- Consistent null-safe empty array returns (`if x == nil { x = []T{} }`)
- Proper path traversal validation via `validateTaskID`
- Atomic file writes in `markTaskComplete` (temp + rename)
- Outside-click handler for project dropdown is clean
- Stage override dialog has good UX: warnings for backward/skip moves

**Architecture note:**
The `buildState` function in serve.go duplicates significant logic from handlers.go (checkpoint loading, stage reading, task reading). As the API grows, this duplication will drift. Consider having `buildState` call through `api.Server` methods or shared helpers.

---

## Requirements Coverage

| Req  | Status     | Notes                                               |
| ---- | ---------- | --------------------------------------------------- |
| R1.1 | ✅ Done    | `loadCheckpoints` reads from correct path           |
| R1.2 | ✅ Done    | `handleStatus` includes checkpoints                 |
| R1.3 | ✅ Done    | Types match, UI renders checkpoints                 |
| R2.1 | ✅ Done    | Dynamic zones from tasks+workers, no hardcoded list |
| R2.2 | ✅ Done    | Task counts per zone displayed                      |
| R2.3 | ⚠️ Partial | ZONE_GLYPHS defined but not used in UI              |
| R3.1 | ✅ Done    | Reads from ~/.mc/projects.json correctly            |
| R3.2 | ✅ Done    | Project switcher dropdown in header                 |
| R3.3 | ⚠️ Partial | No WS broadcast on project switch (M3)              |
| R4.1 | ✅ Done    | Override button wired to dialog                     |
| R4.2 | ✅ Done    | Stage selector with icons and warnings              |
| R4.3 | ❌ Missing | Reason not passed to CLI (C1), no WS broadcast (C2) |
