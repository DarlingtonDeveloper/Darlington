# Summary

Detailed requirements and acceptance criteria for the 5 MC Dashboard Visibility features, based on discovery of existing code patterns, API shapes, and type mismatches.

---

## REQ-1: Worker Lifecycle Panel

### Description

Extend the existing `MissionView` to show workers with accurate lifecycle status badges (spawning → running → complete → failed) mapped from backend fields, with real-time WebSocket updates and click-to-expand detail.

### Files to Modify

- **`lib/mc/types.ts`** — Extend `WorkerStatus` type to include backend-native values; add adapter type
- **`lib/mc/use-mc-websocket.ts`** — Add worker field adapter in `handleWorkerEvent` and initial sync hydration
- **`components/mc/mission-view.tsx`** — Add worker count badges for new statuses
- **`components/mc/zone-group.tsx`** — Update worker card rendering for new status badges

### Files to Create

- **`lib/mc/adapters.ts`** — Adapter functions: `adaptWorker(raw) → Worker` mapping `worker_id→id`, `status:"running"→"busy"`, `token_count→tokens`, `task_id→task`, `started_at→uptime` (computed)
- **`components/mc/worker-detail-panel.tsx`** — Expandable panel showing persona, task link, session info, model, started_at

### Acceptance Criteria

1. `WorkerStatus` type includes `"spawning" | "running" | "complete" | "failed"` alongside existing values, OR adapter maps backend→frontend consistently
2. `adaptWorker()` correctly maps all fields from `/api/workers` shape to frontend `Worker` type — no `undefined` renders
3. Worker cards show colour-coded status badges: spawning=yellow, running=blue, complete=green, failed=red
4. WebSocket `worker.spawned` event → new worker appears in panel within 2s
5. WebSocket `worker.terminated` event → worker moves to complete/removed state
6. Clicking a worker row expands to show: persona, task ID (linked), model, zone, started_at, token_count, cost_usd
7. `tsc --noEmit` passes with no type errors on Worker-related code

---

## REQ-2: Gate Conditions Panel

### Description

Show per-stage gate criteria as a visual checklist (✓/✗) with approval notes, updated in real-time via the existing `gate` WebSocket topic handler.

### Files to Modify

- **`lib/mc/types.ts`** — Extend `GateCriteria` to include `approval_note?: string` and per-criterion met/unmet status (backend sends `criteria` as array of objects with `description` and `met` fields, not just strings)
- **`components/mc/activity-view.tsx`** — Currently renders gate status; either extend here or extract

### Files to Create

- **`components/mc/gate-conditions-panel.tsx`** — Dedicated panel showing each stage's criteria as a checklist with ✓ (green) / ✗ (muted) icons, plus `approval_note` and `approved_at` when present

### Acceptance Criteria

1. For each stage in `gates`, all criteria render as individual checklist items with ✓ or ✗
2. When `status === "approved"`, show green "Approved" badge + `approval_note` text + `approved_at` timestamp
3. When `status === "rejected"`, show red "Rejected" badge
4. WS `gate` topic event updates the panel in real-time — approve a gate → checklist and badge update without page refresh
5. Panel is accessible from Mission View (e.g. as a collapsible section or tab alongside workers)
6. Empty criteria array shows "No criteria defined" placeholder

---

## REQ-3: Token Usage Display

### Description

Replace hardcoded token stats with live data from `/api/tokens` and WS `token` topic. Show per-worker breakdowns and total mission cost.

### Files to Modify

- **`lib/mc/types.ts`** — Add `budget_remaining` to `TokenSummary`; ensure `total_cost` field name is mapped from backend `total_cost_usd`
- **`lib/mc/adapters.ts`** (new, shared) — Add `adaptTokens(raw) → TokenSummary` mapping `total_cost_usd→total_cost`
- **`lib/mc/use-mc-websocket.ts`** — Apply token adapter in initial sync and `token` topic handler
- **`components/mc/dashboard-header.tsx`** — Remove hardcoded `142/m` burn rate; compute from real token deltas or display `budget_used / budget_limit`
- **`components/mc/activity-view.tsx`** — Wire token chart and cost-by-persona to real `sessions` data

### Files to Create

- **`components/mc/token-usage-panel.tsx`** — Table/list showing per-worker: `worker_id`, `persona`, `model`, `input_tokens`, `output_tokens`, `total_tokens`, `estimated_cost_usd`. Footer: total mission tokens + cost + budget remaining.

### Acceptance Criteria

1. Header token stats (TOK, COST) sourced from `TokenSummary` — no hardcoded values
2. Burn rate either computed from rolling token delta or removed entirely (no fake `142/m`)
3. Per-worker token table renders all `sessions` entries from `/api/tokens`
4. `total_cost_usd` from backend correctly maps to `total_cost` in frontend
5. `budget_limit`, `budget_used`, `budget_remaining` all rendered (progress bar or text)
6. WS `token` topic updates → totals refresh in real-time
7. Zero-state: when no tokens consumed, show "No token usage yet" not broken UI

---

## REQ-4: Bridge Status Indicator

### Description

Add a simple connected/disconnected indicator for the OpenClaw bridge, fetched from `/api/openclaw/status`.

### Files to Modify

- **`components/mc/dashboard-header.tsx`** — Add bridge status indicator in identity block or connection area (near existing MC WS connection dot)

### Files to Create

- **`lib/mc/use-bridge-status.ts`** — Hook that polls `/api/openclaw/status` every 10s, returns `{ connected: boolean, loading: boolean, error: boolean }`
- **`components/mc/bridge-status-indicator.tsx`** — Small component: green `StatusDot` + "Bridge" when connected, red dot + "Bridge offline" when not

### Acceptance Criteria

1. Indicator visible in dashboard header, subtle placement (not dominant)
2. Green dot + "Bridge" label when `/api/openclaw/status` returns 200 with connected state
3. Red dot + "Bridge offline" when endpoint returns error/disconnected or fetch fails
4. Polls every 10s; does not block initial render (shows loading/unknown state initially)
5. Uses existing `StatusDot` component for visual consistency
6. Stopping the bridge → indicator flips to disconnected within 10s

---

## REQ-5: Infrastructure Fixes

### Description

Fix type mismatches, wire unhandled WS topics, add stale cache recovery, and handle missing endpoints gracefully.

### Files to Modify

- **`lib/mc/types.ts`**:
  - `GateCriteria.criteria` → change from `string[]` to `Array<{ description: string; met: boolean }>` (or keep string[] with adapter)
  - Add `approval_note?: string` to `GateCriteria`
  - Add `budget_remaining: number` to `TokenSummary`
  - Add `started_at?: string`, `model?: string` to `Worker`

- **`lib/mc/use-mc-websocket.ts`**:
  - Add `case "audit":` handler → append to new `audit: AuditEntry[]` state slice
  - Add `case "checkpoint":` handler → append/update `checkpoints: CheckpointInfo[]` state slice
  - Add `case "zone":` handler → update zone metadata if applicable
  - Add `case "chat":` handler → no-op or append to chat state (chat uses separate WS, so log only)
  - Add reinit detection: if `sync.initial_state` arrives and state already has data, clear old state before hydrating (stale cache fix)
  - Trigger `request_sync` after reconnect to ensure fresh state

- **`lib/mc/types.ts`** (`MCState`):
  - Add `audit: AuditEntry[]` and `checkpoints: CheckpointInfo[]` to `MCState`

- **`components/mc/activity-view.tsx`**:
  - Guard against `/api/audit` 404 — show "Audit trail unavailable" instead of empty/broken state
  - Wire `audit` and `checkpoints` from MCState

### Files to Create

- **`lib/mc/adapters.ts`** — Central adapter module for all backend→frontend type mappings

### Acceptance Criteria

1. `tsc --noEmit` passes with zero errors after type fixes
2. All 9 subscribed WS topics have handlers in the switch statement (no unhandled topics fall to default)
3. On WS reconnect, `request_sync` is sent to get fresh state; old state is cleared on new `initial_state`
4. After `mc init` (reinit), dashboard shows fresh state within 5s — no stale workers/tasks from prior mission
5. `/api/audit` 404 handled gracefully — activity view shows placeholder, no console errors
6. `GateCriteria` type matches actual backend shape (criteria objects, approval_note field)
7. `TokenSummary` includes `budget_remaining`
8. Worker adapter handles all backend fields without `undefined` leaks

---

## Implementation Order (Recommended)

1. **REQ-5** first — fixes foundation (types, adapters, WS handlers)
2. **REQ-1** — worker panel (depends on fixed types + adapter)
3. **REQ-3** — token display (depends on fixed token types)
4. **REQ-2** — gate panel (depends on fixed gate types)
5. **REQ-4** — bridge indicator (independent, can parallel with 2-3)

## Component Strategy

| Feature       | Extend Existing                             | Create New                                            |
| ------------- | ------------------------------------------- | ----------------------------------------------------- |
| Worker Panel  | `mission-view.tsx`, `zone-group.tsx`        | `worker-detail-panel.tsx`, `adapters.ts`              |
| Gate Panel    | `activity-view.tsx`                         | `gate-conditions-panel.tsx`                           |
| Token Display | `dashboard-header.tsx`, `activity-view.tsx` | `token-usage-panel.tsx`                               |
| Bridge Status | `dashboard-header.tsx`                      | `bridge-status-indicator.tsx`, `use-bridge-status.ts` |
| Infra Fixes   | `types.ts`, `use-mc-websocket.ts`           | `adapters.ts`                                         |
