# Summary

Security review of MissionControl API endpoints (findings, briefings, file serving) and Darlington FindingsView component. **Overall: LOW-MEDIUM risk.** The implementation is reasonable but has several issues worth addressing.

## Findings

### 1. Path Traversal — validateTaskID is Sufficient ✅

`validateTaskID` rejects empty strings, `..`, `/`, and `\`. Since the ID is concatenated as `{id}.md` or `{id}-briefing.json` within a fixed directory, this is adequate. No bypass vector identified — the validation blocks all known traversal techniques for this use case.

**Verdict:** PASS

### 2. File Serving — No Arbitrary File Read ✅

Both `handleTaskFindings` and `handleTaskBriefing` construct paths via `s.missionPath()` which anchors to `{missionDir}/.mission/`. Combined with `validateTaskID`, the served files are constrained to `findings/{id}.md` and `handoffs/{id}-briefing.json`. No user-controlled extension or directory component.

**Verdict:** PASS

### 3. XSS via Markdown Rendering — LOW RISK ⚠️

`FindingsView` uses `react-markdown` with `remarkGfm`. `react-markdown` does **not** render raw HTML by default (it strips it), so standard XSS via `<script>` tags in markdown is blocked.

However:

- **Link injection**: The `a` component renders `href` directly. A malicious findings file could contain `[click](javascript:alert(1))` — though `react-markdown` typically filters `javascript:` URIs, this should be explicitly verified or a `transformLinkUri` prop added.
- **Findings files are authored by trusted workers** (sub-agents), not arbitrary users, reducing practical risk.

**Recommendation:** Add `transformLinkUri` to strip `javascript:` and `data:` schemes explicitly, as defense-in-depth.

### 4. CORS and Auth on New Endpoints ✅

- New `/api/tasks/{id}/findings` and `/api/tasks/{id}/briefing` endpoints go through `api.Server.Routes()` → mounted on `/api/` in the outer mux → wrapped with `CORSMiddleware` and `AuthMiddleware` via `api.Chain()`. Both middleware apply correctly.
- CORS allowlist is explicit (darlington.dev + localhost:3000).
- Auth is bearer-token based with env var `MC_API_TOKEN`. When unset, auth is disabled — acceptable for local-only use but should be documented.

**Verdict:** PASS

### 5. Error Messages Leaking Internal Paths — LOW RISK ⚠️

Error responses in `handleTaskFindings` and `handleTaskBriefing` use generic messages ("findings not found", "failed to read findings") rather than exposing `err.Error()`. This is correct.

However, other handlers (e.g. `handleTasks`, `handleAudit`) pass `err.Error()` directly to `respondError`, which could leak filesystem paths.

**Recommendation:** Audit all `respondError` calls and ensure none pass raw `os` errors to clients.

### 6. handleProjectSwitch — MEDIUM RISK ⚠️

`handleProjectSwitch` accepts an arbitrary `path` from the request body, validates only that `{path}/.mission` exists, then sets `s.missionDir = req.Path`. This allows any authenticated user to pivot the entire API to serve files from any directory on disk that contains a `.mission` folder. An attacker with API access could:

- Point to a crafted `.mission` directory to serve arbitrary files via the findings/briefing endpoints
- Read `audit.jsonl`, `tasks.jsonl`, etc. from any project

**Recommendation:** Restrict to a whitelist of known project directories, or remove this endpoint if unused.

### 7. Auth Bypass via Missing MC_API_TOKEN — INFO ℹ️

When `MC_API_TOKEN` is not set, all endpoints are unauthenticated. This is by design for local dev but should emit a startup warning. If deployed with the env var unset, all endpoints are open.

### 8. WebSocket Endpoint Bypasses Auth — LOW RISK ⚠️

`/ws` is registered on the outer mux and goes through `Chain(mux, CORSMiddleware, AuthMiddleware)`, so it does get auth. Confirmed: no bypass.

**Verdict:** PASS

## Risk Summary

| Finding              | Severity | Action                                   |
| -------------------- | -------- | ---------------------------------------- |
| Path traversal       | None     | No action needed                         |
| Arbitrary file read  | None     | No action needed                         |
| XSS in markdown      | Low      | Add `transformLinkUri`                   |
| CORS/Auth coverage   | None     | No action needed                         |
| Error path leakage   | Low      | Sanitize `err.Error()` in other handlers |
| Project switch pivot | Medium   | Whitelist allowed project paths          |
| Missing auth token   | Info     | Add startup warning                      |
