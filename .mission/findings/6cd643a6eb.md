# Summary

Research on the current MC dashboard frontend and backend APIs for the Dashboard Visibility mission.

## Current Dashboard Structure

### Views (3 tabs)

1. **Mission View** (`mission-view.tsx`) — Workers grouped by zone (frontend/backend/database/infra/shared) + Kai chat panel
2. **Trace View** (`trace-view.tsx`) — SVG dependency graph of tasks with edges, filters by stage/status, detail panel on click
3. **Activity View** (`activity-view.tsx`) — Gate status, audit trail, stats grid, checkpoints, token usage chart, cost-by-persona bars

### Header (`dashboard-header.tsx`)

- Identity block (MissionControl branding + connection status)
- Task stat chips: active/blocked/pending/done counts
- Token stats: TOK count, COST, BURN rate (hardcoded 142/m)
- Pipeline bar showing all 10 stages with gate status
- View tab switcher

### Chat Panel (`chat-panel.tsx`)

- Connects directly to OpenClaw gateway WebSocket (not MC WebSocket)
- Uses device identity + crypto signatures for auth
- Streams chat responses via `chat` events
- Loads history via `chat.history` RPC

### WebSocket Hook (`use-mc-websocket.ts`)

- Connects to `MC_WS_URL` (wss://mc.darlington.dev/ws)
- Subscribes to topics: `stage`, `task`, `worker`, `gate`, `token`, `chat`, `zone`, `checkpoint`, `audit`
- Handles `sync.initial_state` for full state hydration
- Handles incremental events per topic (task created/updated/deleted, worker spawned/updated/terminated, gate changes, token updates)
- **Missing handlers**: `chat`, `zone`, `checkpoint`, `audit` topics subscribed but NOT handled in the switch statement

## API Response Shapes

### GET /api/workers

```json
[
  {
    "worker_id": "mc-worker-e2e-test",
    "persona": "tester",
    "task_id": "e2e-test",
    "zone": "backend",
    "model": "claude",
    "pid": 0,
    "status": "running",
    "started_at": "2026-02-09T21:31:21.225205844Z",
    "token_count": 0,
    "cost_usd": 0
  }
]
```

**Note**: Backend uses `worker_id` not `id`, `status: "running"` not `"busy"`. Frontend `Worker` type expects `id`, `status: WorkerStatus("busy"|"idle"|"error"|"offline")`, `task` (string), `uptime` (number), `tokens` (number). **Mismatch between API and frontend types.**

### GET /api/gates

Returns 404 — not implemented at `/api/gates` directly. Gates come via `/api/status`.

### GET /api/tokens

```json
{
  "total_tokens": 0,
  "total_cost_usd": 0,
  "sessions": [],
  "budget_limit": 0,
  "budget_used": 0,
  "budget_remaining": 0
}
```

**Note**: Backend uses `total_cost_usd`, frontend type expects `total_cost`. Minor field name mismatch. Backend also has `budget_remaining` not in frontend type.

### GET /api/status (comprehensive)

Returns full state:

```json
{
  "gates": { "<stage>": { "stage", "status", "criteria": [], "approved_at", "approval_note" } },
  "stage": { "current": "release", "updated_at": "..." },
  "tasks": [{ "id", "name", "persona", "stage", "status", "zone", "created_at", "updated_at", "scope_paths"?, "depends_on"? }],
  "tokens": { ... same as /api/tokens },
  "workers": [ ... same as /api/workers ]
}
```

### GET /api/audit

Returns 404 — **not implemented**.

## WebSocket Hub (hub.go)

### Event Structure

```go
type Event struct {
    Topic string          `json:"topic"`
    Type  string          `json:"type"`
    Data  json.RawMessage `json:"data"`
}
```

### Client Commands

- `subscribe` — subscribe to topic list
- `unsubscribe` — unsubscribe from topics
- `request_sync` — request full state resend

### Auth

- Bearer token via `Authorization` header or `?token=` query param
- `MC_API_TOKEN` env var; empty = auth disabled

### Initial State

- On connect, hub sends `{topic: "sync", type: "initial_state", data: <full state>}` via `stateProvider` callback

### Broadcast Topics (from code analysis)

Topics are arbitrary strings passed to `BroadcastRaw(topic, eventType, data)`. Based on WS hook subscriptions and handler code:

- `stage` — stage transitions (type: varies, data: `{current: "<stage>"}`)
- `task` — created/updated/status_changed/deleted
- `worker` — spawned/updated/status_changed/terminated
- `gate` — gate status changes
- `token` — token usage updates
- `chat` — chat messages (subscribed but unhandled)
- `zone` — zone events (subscribed but unhandled)
- `checkpoint` — checkpoint events (subscribed but unhandled)
- `audit` — audit events (subscribed but unhandled)

## Design Patterns

### Styling

- **Dark theme**: bg `#07070e`, text `#e8e4df`, accent `#c4b5a0`, muted `#6b6560`/`#4a4540`
- **Borders**: `border-white/[0.06]`, `border-white/[0.04]`
- **Cards**: `bg-white/[0.02]` with subtle borders
- **Fonts**: serif for headings, mono for data/labels
- **Badge variants**: default, accent, success, warning, danger
- All Tailwind CSS, no CSS modules

### Component Patterns

- Shared primitives: `Card`, `Badge`, `SectionLabel`, `ActionButton`, `StatusDot`
- State managed via WebSocket hook returning `MCState`
- Actions via REST POST calls (kill worker, approve/reject gate, create/restore checkpoint)
- Constants in `lib/mc/constants.ts` (API URL, WS URL, token)

## What's Missing (Gaps for Mission 1)

1. **Audit trail has no data** — `/api/audit` returns 404, `ActivityView` receives empty `audit=[]`, WS audit events subscribed but unhandled
2. **Checkpoints have no data** — `ActivityView` receives empty `checkpoints=[]`, no fetch from API
3. **Worker type mismatch** — backend `worker_id`/`status:"running"` vs frontend `id`/`status:"busy"` — needs adapter or backend alignment
4. **Token field mismatch** — `total_cost_usd` vs `total_cost`
5. **No real-time audit/checkpoint/zone/chat handling** in WS hook switch statement
6. **Burn rate hardcoded** at 142/m in header
7. **No worker stdout/log streaming** — `Worker.stdout` field exists in types but never populated
8. **Graph data always null** — `TraceView` always gets `graph={null}`, derives from tasks only
9. **Gates not fetched independently** — only via initial WS sync or `/api/status`
10. **No error handling/loading states** in views
