# Summary

Security review of MissionControl API handlers and Darlington MC dashboard components.

## Findings

### 1. [HIGH] Project Switch — Arbitrary Path Traversal

**File:** `orchestrator/api/handlers.go` → `handleProjectSwitch()`

The endpoint accepts any `path` from the request body and sets it as `s.missionDir` after only checking that `<path>/.mission` exists. No validation that the path is within an allowed directory or matches a registered project. An attacker who can reach this endpoint can:

- Point `missionDir` to any directory with a `.mission/` subfolder (trivially created)
- Subsequently read arbitrary `.json`, `.jsonl`, and `.md` files via the status/tasks/findings/specs endpoints (which all resolve relative to `missionDir`)
- Effectively gain read access to sensitive files outside intended project directories

**Recommendation:** Validate `req.Path` against the project registry (`~/.mc/projects.json`). Reject paths not in the registry. Use `filepath.Clean` and confirm the resolved path matches exactly.

### 2. [MEDIUM] Stage Override — No Authorization Check

**File:** `orchestrator/api/handlers.go` → `handleStageOverride()`

The stage override endpoint accepts any stage string and delegates to `mc stage set` with no authentication or authorization. The frontend (`stage-override-dialog.tsx`) requires a reason, but the API does not — the reason field isn't even read from the request body. Any HTTP client can bypass gates silently.

**Recommendation:**

- Read and log the `reason` field server-side (it's in `StageOverrideRequest` but unused)
- Add audit logging for stage overrides
- Consider requiring a confirmation token or admin auth header

### 3. [MEDIUM] Command Injection via Task/Worker Operations

**File:** `orchestrator/api/handlers.go` → `handleUpdateTask()`, `handleCreateTask()`, `handleTaskDependencies()`

User-supplied strings (`req.Title`, `req.Status`, `req.Stage`, `req.Zone`, `req.DepID`, task `id`) are passed directly as arguments to `exec.Command("mc", args...)`. While Go's `exec.Command` does not invoke a shell (so classic shell injection is mitigated), the `mc` CLI may interpret special values (e.g., flags starting with `--`) as arguments. A title like `--stage` could confuse argument parsing.

**Recommendation:** Validate inputs against allowlists (status values, stage names). For free-text fields like title, ensure they don't start with `-`.

### 4. [LOW] Checkpoint ID Not Validated in Restart

**File:** `orchestrator/api/handlers.go` → `handleRestartCheckpoint()`

The checkpoint `id` is passed to `mc checkpoint restart` without `validateTaskID()` checks. While `exec.Command` prevents shell injection, malformed IDs could cause unexpected CLI behavior.

**Recommendation:** Apply `validateTaskID()` to checkpoint IDs.

### 5. [LOW] XSS Risk — Minimal in Current Frontend

**File:** `components/mc/mission-view.tsx`, `components/mc/stage-override-dialog.tsx`

React's JSX escaping handles most XSS vectors. Content rendered is from the MC API (task names, zone names, stage names, checkpoint metadata). Since these originate from the local `mc` CLI and state files rather than untrusted user input, risk is low. However:

- `cp.stage` is used as a key into `STAGE_ICONS` and rendered directly — if stage names contained HTML-like strings, React would escape them
- Error messages from the API (`result.error`, `e.message`) are rendered in the override dialog — safe via JSX but worth noting

No active XSS vulnerability identified.

### 6. [INFO] Checkpoint File Reading — Bounded by Directory Listing

**File:** `orchestrator/api/handlers.go` → `loadCheckpoints()`

Checkpoints are loaded by listing `.mission/orchestrator/checkpoints/` and reading only `.json` files found there. File names come from `os.ReadDir`, not user input, so path traversal isn't possible here. This is well-implemented.

### 7. [INFO] `validateTaskID` — Adequate but Narrow

The function rejects `..`, `/`, and `\` which prevents directory traversal for task/spec/findings IDs. This is sufficient for its current use cases.

## Risk Summary

| #   | Severity | Issue                                       | Status        |
| --- | -------- | ------------------------------------------- | ------------- |
| 1   | HIGH     | Project switch accepts arbitrary paths      | Open          |
| 2   | MEDIUM   | Stage override has no auth or audit logging | Open          |
| 3   | MEDIUM   | CLI argument confusion possible             | Open          |
| 4   | LOW      | Checkpoint restart ID not validated         | Open          |
| 5   | LOW      | XSS — no active vulnerability found         | Informational |
| 6   | INFO     | Checkpoint loading is safe                  | OK            |
| 7   | INFO     | validateTaskID is adequate                  | OK            |
