# Summary

Requirements for MC Dashboard Mission 3B — Checkpoints, Zones, Projects, Stage Override.

---

## R1: Checkpoint Path Fix + UI

### Problem

The API handler `handleCheckpoints` reads from `.mission/checkpoints/` (looking for subdirectories), but the `mc checkpoint` CLI writes JSON files to `.mission/orchestrator/checkpoints/<timestamp>.json`. The dashboard always shows "No checkpoints yet" even when checkpoints exist.

### Requirements

**R1.1 — Fix checkpoint read path in API**

- Change `handleCheckpoints` GET to read from `.mission/orchestrator/checkpoints/` instead of `.mission/checkpoints/`
- Parse checkpoint JSON files (not subdirectories) to extract id, timestamp, stage, task count
- Return `[]CheckpointInfo` with fields: `id`, `timestamp`, `stage`, `task_count`, `auto`

**R1.2 — Include checkpoints in /api/status response**

- Add checkpoints array to the status endpoint so WebSocket sync delivers checkpoint data on connect
- Currently checkpoints are only received via WebSocket "checkpoint" events (new ones), but initial load has no source

**R1.3 — Checkpoint list UI (already exists, verify data flow)**

- ActivityView already renders checkpoints with Create/Restore buttons
- Verify `CheckpointInfo` type in `types.ts` matches actual API response shape after fix
- Frontend `CheckpointInfo` expects `{id, stage, created_at, task_count?, auto?}` — API must return these fields

### Acceptance Criteria

- [ ] `GET /api/checkpoints` returns checkpoints created by `mc checkpoint` CLI
- [ ] Checkpoint list in ActivityView displays real checkpoint data (id, stage, timestamp)
- [ ] "Create" button creates a checkpoint and it appears in the list
- [ ] "Restore" button triggers `mc checkpoint restart <id>` successfully

### Files to Modify

- `MissionControl/orchestrator/api/handlers.go` — fix `handleCheckpoints` path and parsing
- `MissionControl/orchestrator/api/handlers.go` — add checkpoints to `handleStatus`
- `MissionControl/orchestrator/api/types.go` — verify/update `CheckpointInfo` struct fields
- `Darlington/lib/mc/use-mc-websocket.ts` — verify initial sync includes checkpoints

---

## R2: Zones View

### Problem

Zones are derived from task metadata (no dedicated zones.json exists). The MissionView hardcodes `ZONES = ["frontend", "backend", "database", "infra", "shared"]` and only shows zones that have active workers. There's no standalone zones view showing tasks grouped by zone.

### Requirements

**R2.1 — Dynamic zone list from API**

- Remove hardcoded `ZONES` constant from `mission-view.tsx`
- Use zones from `/api/status` response (already included via `deriveZones`)
- The WebSocket sync subscribes to "zone" topic — verify zone updates propagate

**R2.2 — Zone-grouped task display**

- In MissionView, show tasks grouped by zone (not just workers)
- Each zone section should show: zone name, task count, task status breakdown (pending/in_progress/complete/blocked)
- Workers within each zone shown alongside their assigned tasks

**R2.3 — Zone glyphs and styling**

- `types.ts` already defines `ZONE_GLYPHS` — use these in zone headers
- Support unknown zone names gracefully (default glyph)

### Acceptance Criteria

- [ ] Zones displayed dynamically based on actual task data, not hardcoded list
- [ ] Each zone shows its tasks with status indicators
- [ ] Workers are associated with their zone's task group
- [ ] Empty zones (no tasks or workers) are hidden

### Files to Modify

- `Darlington/components/mc/mission-view.tsx` — replace hardcoded ZONES, add task grouping
- `Darlington/components/mc/zone-group.tsx` — extend to show tasks alongside workers
- `Darlington/lib/mc/use-mc-websocket.ts` — verify zone topic handling

---

## R3: Project Switcher + Registry Fix

### Problem

Two separate project registries exist:

- CLI uses `~/.mc/projects.json` — format: `{"projects": {"name": "/path/to/.mission"}}`
- API uses `~/.mission-control/config.json` — format: `GlobalConfig` with `projects[]` array (file doesn't exist)

The `handleProjects` GET in `handlers.go` reads from `~/.mission-control/config.json` which doesn't exist, so always returns empty. Meanwhile `projects.go` has a more complete `ProjectsHandler` that also reads from `~/.mission-control/config.json`.

### Requirements

**R3.1 — Unify project registry to CLI format**

- Change `handleProjects` GET to read from `~/.mc/projects.json` (the CLI's registry)
- Transform the CLI format `{projects: {name: path}}` into an array response: `[{name, path, active}]`
- Mark the currently active project (matching `s.missionDir`)

**R3.2 — Project switcher UI component**

- Add a dropdown/selector to `DashboardHeader` showing registered projects
- Current project highlighted/selected
- Switching calls `POST /api/projects` with the project path
- After switch, full state re-sync (WebSocket reconnect or manual refresh)

**R3.3 — Project switch backend**

- `handleProjectSwitch` POST already works (validates `.mission` dir, updates `s.missionDir`)
- Add WebSocket broadcast on project switch so all connected clients update
- Consider: should switching also notify WebSocket subscribers to re-sync?

### Acceptance Criteria

- [ ] `GET /api/projects` returns projects from `~/.mc/projects.json`
- [ ] Project switcher dropdown appears in dashboard header
- [ ] Selecting a different project switches the API's mission directory
- [ ] Dashboard state refreshes to show the new project's data
- [ ] Current project is visually indicated

### Files to Modify

- `MissionControl/orchestrator/api/handlers.go` — change `handleProjects` to read `~/.mc/projects.json`
- `Darlington/components/mc/dashboard-header.tsx` — add project switcher dropdown
- `Darlington/lib/mc/types.ts` — add `ProjectInfo` type
- `Darlington/lib/mc/use-mc-websocket.ts` — handle project switch re-sync

---

## R4: Stage Override Controls

### Problem

The backend `POST /api/stages/override` exists and works (calls `mc stage set`). The ActivityView has an "Override" ghost button next to gate approve/reject, but it has no onClick handler. No confirmation dialog exists.

### Requirements

**R4.1 — Stage override UI with confirmation**

- Wire the "Override" button in ActivityView to open a confirmation dialog
- Dialog shows: current stage, dropdown to select target stage (from `STAGES` constant in types.ts), text input for reason
- Confirmation calls `POST /api/stages/override` with `{stage: string}`
- Display success/error result

**R4.2 — Stage selector component**

- Dropdown listing all 10 stages with their emoji icons (`STAGE_ICONS` from types.ts)
- Current stage indicated, forward jumps flagged as potentially gate-skipping
- Backward jumps allowed (re-entering earlier stages)

**R4.3 — Stage override event handling**

- On successful override, update local stage state
- WebSocket already handles "stage" topic events — verify the API broadcasts stage changes
- Add audit trail entry visibility for stage overrides

### Acceptance Criteria

- [ ] "Override" button opens a confirmation dialog with stage selector
- [ ] Selecting a stage and confirming calls the backend
- [ ] Stage display updates after successful override
- [ ] Error messages shown if gate enforcement rejects the change
- [ ] Reason field is optional but passed through if provided

### Files to Modify

- `Darlington/components/mc/activity-view.tsx` — wire Override button, add dialog
- `Darlington/components/mc/stage-override-dialog.tsx` — new component
- `Darlington/lib/mc/types.ts` — already has STAGES/STAGE_ICONS (no changes needed)
- `MissionControl/orchestrator/api/handlers.go` — add `--reason` flag support to `handleStageOverride`, broadcast via WebSocket

---

## File Index (all files to modify)

| File                                                 | Requirements           |
| ---------------------------------------------------- | ---------------------- |
| `MissionControl/orchestrator/api/handlers.go`        | R1.1, R1.2, R3.1, R4.3 |
| `MissionControl/orchestrator/api/types.go`           | R1.3                   |
| `Darlington/components/mc/mission-view.tsx`          | R2.1, R2.2             |
| `Darlington/components/mc/zone-group.tsx`            | R2.2                   |
| `Darlington/components/mc/activity-view.tsx`         | R4.1                   |
| `Darlington/components/mc/stage-override-dialog.tsx` | R4.2 (new)             |
| `Darlington/components/mc/dashboard-header.tsx`      | R3.2                   |
| `Darlington/lib/mc/types.ts`                         | R3.2                   |
| `Darlington/lib/mc/use-mc-websocket.ts`              | R1.2, R2.3, R3.3       |
