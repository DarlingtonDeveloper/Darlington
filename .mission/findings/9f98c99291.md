# Summary

All 6 verify issues fixed and all verify commands pass.

## Fixes Applied

### 1. HIGH: Validate project switch path against registry (security)

**File:** `orchestrator/api/handlers.go` — `handleProjectSwitch`

- Loads `~/.mc/projects.json` and checks the requested path exists in the registry
- Returns 403 Forbidden if path is not a registered project
- Returns 500 if registry cannot be read

### 2. CRITICAL: Pass reason to stage override CLI command

**File:** `orchestrator/api/handlers.go` — `handleStageOverride`, `orchestrator/api/types.go` — `StageOverrideRequest`

- Added `Reason` field to `StageOverrideRequest`
- Passes `--reason <reason>` flag to `mc stage set` when reason is provided

### 3. CRITICAL: Broadcast stage_changed via WS hub after override

**File:** `orchestrator/api/handlers.go` — `handleStageOverride`

- After successful stage override, broadcasts `stage_changed` event on `stage` topic via hub
- Includes both stage and reason in the broadcast payload

### 4. CRITICAL: Add mutex for missionDir on project switch

**File:** `orchestrator/api/routes.go` — `Server` struct, `orchestrator/api/handlers.go`

- Added `sync.RWMutex` to `Server` struct
- `handleProjectSwitch` uses `mu.Lock()` when writing `missionDir`
- `getMissionDir()` accessor uses `mu.RLock()` for all reads
- `statePath`, `missionPath`, `runMC`, `handleProjects` all use the safe accessor

### 5. HIGH: Fix stale checkpoint test

**File:** `orchestrator/api/routes_test.go` — `TestCheckpointsList`, `newTestServer`

- Updated `newTestServer` to create `.mission/orchestrator/checkpoints/` (matching `loadCheckpoints()`)
- Updated test to create a JSON file instead of a directory
- Changed assertion to use `map[string]interface{}` instead of `CheckpointInfo` (which lacks the new fields)

### 6. MEDIUM: Return [] when projects.json missing

**File:** `orchestrator/api/handlers.go` — `handleProjects`

- Added nil check for `registry.Projects` map — returns `[]` if projects key is null/missing
- Existing `readJSON` error handling already returned `[]` on file-not-found

## Verification

All 3 verify commands pass:

- `go test ./...` — all 12 packages OK
- `go build ./...` (cmd/mc) — clean build
- `npx tsc --noEmit` (Darlington) — no errors
